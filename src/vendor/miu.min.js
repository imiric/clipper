function p(r){return r===null||typeof r!="object"||typeof r=="function"?typeof r=="function"?void 0:r:Array.isArray(r)?r.map(e=>p(e)):r instanceof Map?new Map(Array.from(r.entries()).filter(([e,t])=>typeof t!="function").map(([e,t])=>[e,p(t)])):Object.fromEntries(Object.entries(r).filter(([e,t])=>typeof t!="function").map(([e,t])=>[e,p(t)]))}var v=class{constructor(e,t={}){if(typeof e!="string")throw new Error("[miu] Store name must be a string");let o=new Map,n=this._createPathOps(),s=this._createState(t,o,n),d=this._createAPI(s,o,n);return d.$name=e,new Proxy(d,{get:(h,l)=>l.toString().startsWith("$")?h[l]:s[l],set:(h,l,w)=>{if(l.toString().startsWith("$"))throw new Error(`[miu] '${l}' is read-only`);return s[l]=w,!0}})}_createPathOps(){return{get:(e,t)=>t.split(/[.\[]/).map(o=>o.replace("]","")).reduce((o,n)=>o&&o[n],e),set:(e,t,o)=>{let n=t.split(/[.\[]/).map(h=>h.replace("]","")),s=n.pop(),d=n.reduce((h,l)=>(h[l]||(h[l]={}),h[l]),e);d[s]=o}}}_validatePath(e){if(typeof e>"u")throw new Error("[miu] path is undefined");if(e==="")return;let t=["^","(?:[a-zA-Z_$][\\w$]*)","(?:","\\.[a-zA-Z_$][\\w$]*|","\\[[^\\[\\]]+\\]",")*","(?:.(?:length|size))?","$"];if(!new RegExp(t.join("")).test(e))throw new Error("[miu] Invalid path syntax")}_createAPI(e,t,o){return{$get:n=>(this._validatePath(n),o.get(e,n)),$set:(n,s)=>{this._validatePath(n),o.set(e,n,s)},$subscribe:(n,s)=>(this._validatePath(n),t.has(n)||t.set(n,new Set),t.get(n).add(s),()=>{t.get(n).delete(s),t.get(n).size===0&&t.delete(n)}),get $data(){return p(e)}}}_createState(e,t,o){let n=(i,u)=>{t.has("")&&t.get("").forEach(c=>c(e)),t.has(i)&&t.get(i).forEach(c=>c(u));for(let[c,f]of t)if(c.startsWith(i+".")){let y=o.get(e,c);f.forEach(P=>P(y))}let a=i.split(".");for(;a.length>1;){a.pop();let c=a.join(".");if(t.has(c)){let f=o.get(e,c);t.get(c).forEach(y=>y(f))}}},s=(i,u,a)=>(...c)=>{let f=Array.prototype[u].apply(i,c);return["push","pop","shift","unshift","splice","sort","reverse"].includes(u)&&n(a,i),f},d=(i,u,a,c)=>{if(u==="length")return i.length=a,n(c,i),!0;let f=parseInt(u,10);if(isNaN(f)||f<0||f>i.length-1)throw new Error(`[miu] Invalid array index: ${u}`);i[u]=a;let y=`${c}[${u}]`;return n(y,a),n(c,i),!0},h=(i,u,a)=>{let c={get:f=>{let y=i.get(f);return typeof y=="object"&&y!==null?w(y,`${a}[${f}]`):y},set:(f,y)=>(i.set(f,y),n(`${a}[${f}]`,y),n(a,i),i),delete:f=>{let y=i.has(f),P=i.delete(f);return y&&(n(`${a}[${f}]`,void 0),n(a,i)),P},clear:()=>{let f=Array.from(i.keys());i.clear(),f.forEach(y=>n(`${a}[${y}]`,void 0)),n(a,i)}};return u in c?c[u]:typeof i[u]=="function"?i[u].bind(i):i.get(u)},l=i=>({get:(u,a)=>{if(a==="$data")return p(u);let c=u[a];if(typeof c=="function"&&c.constructor.name==="get")return c.call(u);if(typeof a=="symbol")return c;if(u instanceof Map)return h(u,a,i);if(Array.isArray(u)&&Array.prototype[a]&&typeof Array.prototype[a]=="function")return s(u,a,i);let f=i?`${i}.${a}`:a;return typeof c=="object"&&c!==null?w(c,f):c},set:(u,a,c)=>{if(Array.isArray(u))return d(u,a,c,i);let f=i?`${i}.${a}`:a;return u[a]=c,n(f,c),u instanceof Map&&n(i,u),!0},deleteProperty:(u,a)=>{let c=a in u,f=delete u[a];if(c&&f){let y=i?`${i}.${a}`:a;n(y,void 0)}return f}}),w=(i,u="")=>typeof i!="object"||i===null?i:new Proxy(i,l(u));return w(e)}},A=new Map;var $={BIND:"data-miu-bind",FOR:"data-miu-for",INDEX:"data-miu-index",KEY:"data-miu-key"},E="$",M=`${E}key`,k=`${E}value`,T=`${E}index`,O=new WeakMap,S=new WeakMap,b=new WeakMap;function R(r){let e=`[${$.FOR}]`,t=[...r.matches(e)?[r]:[],...r.querySelectorAll(e)];for(let s of t){let{store:d,path:h}=D(s);H(s,d,h)}let o=`[${$.BIND}]`,n=[...r.matches(o)?[r]:[],...r.querySelectorAll(o)];for(let s of n){let d=V(s);F(s,d)}}function m(r){let e=r.parentElement.closest(`[${$.FOR}]`),t=O.get(e),o=r.closest(`[${$.INDEX}]`),n;if(t?.store&&o){let s=o.getAttribute($.INDEX),d=o.getAttribute($.KEY);n={item:t.items[d||s],index:s,key:d,element:o,store:t.store,path:t.path}}return n}function V(r){return r.getAttribute($.BIND).split(/\s+/).filter(Boolean).map(t=>t.includes("->")?W(t,r):B(t))}function W(r,e){let t=r.match(/^(.+?)(->|<->)(.+)$/);if(!t)throw new Error(`[miu] Invalid bind syntax: ${r}. Expected: storePath->target or storePath<->target@event`);let[,o,n,s]=t,d=n==="<->",h,l;if(d){let i=s.split("@");if(i.length!==2)throw new Error(`[miu] Two-way binding requires @event: ${r}`);if([h,l]=i,!h||!l)throw new Error(`[miu] Two-way binding requires both target and event: ${r}`)}else{if(s.includes("@"))throw new Error(`[miu] One-way binding should not specify @event: ${r}`);h=s}return{...o.charAt(0)===E?_($.BIND,o,m(e)):g(o),type:"binding",target:h,twoWay:d,event:l}}function B(r){let e=r.split("@");if(e.length!==2)throw new Error(`[miu] Invalid event binding syntax: ${r}. Expected: storePath.handler@event or globalHandler@event`);let[t,o]=e;if(!t||!o)throw new Error(`[miu] Event binding requires both handler and trigger: ${r}`);let n,s;if(t.includes(".")){let l=g(t);s=l.store,n=s.$get(l.path)}else n=globalThis[t];if(typeof n!="function")throw new Error(`[miu] ${t} is not a function`);let d,h;if(o.includes(".")){let{store:l,path:w}=g(o);d=l,h=w}return{type:"event",...s&&{store:s},fn:n,event:o,...d&&{triggerStore:d,triggerPath:h}}}function D(r){let e=r.getAttribute($.FOR);if(e.charAt(0)===E){let t=m(r);return _($.FOR,e,t)}return g(e)}function _(r,e,t){if(typeof t>"u")throw new Error(`[miu] bind context is undefined for ${e}`);let o=`${t.path}[${t.key||t.index}]`;if(e===E)return{store:t.store,path:o};if(e===M||e===T){if(r===$.FOR)throw new Error(`[miu] ${e} is unsupported for ${$.FOR}`);return{store:t.store,path:o,key:t.key}}if(e.startsWith(`${E}.`))return{store:t.store,path:`${o}${e.slice(1)}`};if(e.startsWith(k))return{store:t.store,path:`${o}${e.slice(6)}`};throw new Error(`[miu] Invalid store reference: ${e}`)}function g(r){let[e,...t]=r.split("."),o=t.join(".");if(!e||!o)throw new Error(`[miu] Invalid path format: ${r}`);let n=A.get(e);if(!n)throw new Error(`[miu] Store not found: ${e}`);return{store:n,path:o}}function I(r,e,t){S.has(r)||S.set(r,new Map);let o=S.get(r);o.has(e)||(r.addEventListener(e,t),o.set(e,t))}function x(r,e,t){b.has(r)||b.set(r,new Map);let o=b.get(r),n=e.type==="event"?`event:${e.event}`:`binding:${e.path}:${e.target}`;if(!o.has(n)){let s=t();o.set(n,s)}}function F(r,e){for(let t of e){if(t.type==="event"){t.triggerStore?x(r,t,()=>t.triggerStore.$subscribe(t.triggerPath,n=>{let s=new CustomEvent("store:change",{detail:{path:t.triggerPath}}),d=m(r);t.fn.call(t.store,s,d,n)})):I(r,t.event,n=>{n.preventDefault();let s=m(r);t.fn.call(t.store,n,s)});continue}let o=t.key??t.store.$get(t.path);t.target==="text"?K(r,t,o):q(r,t,o)}}function q(r,e,t){if((r.tagName==="INPUT"||r.tagName==="TEXTAREA")&&(e.target==="value"||e.target==="checked")){let n=s=>{s=N(e.store,r,s),r[e.target]!==s&&(r[e.target]=s)};n(t),x(r,e,()=>e.store.$subscribe(e.path,n)),e.twoWay&&I(r,e.event,s=>{e.store.$set(e.path,s.target[e.target])})}else{let n=s=>{s=N(e.store,r,s),r.getAttribute(e.target)!==s&&r.setAttribute(e.target,s)};n(t),x(r,e,()=>e.store.$subscribe(e.path,n)),e.twoWay&&I(r,e.event,s=>{e.store.$set(e.path,s.target.getAttribute(e.target))})}}function K(r,e,t){let o=n=>{n=N(e.store,r,n),r.textContent!==n&&(r.textContent=n)};o(t),x(r,e,()=>e.store.$subscribe(e.path,o))}function N(r,e,t){return typeof t=="function"&&(t=t.call(r,m(e))),t}var C=(r,e)=>{if(r==null)throw new Error(`[miu] Value of ${e} is null or undefined`);let t=0;if(Array.isArray(r))return function*(){for(let o of r)yield[t,void 0,o],t++}();if(r instanceof Map)return function*(){for(let[o,n]of r.entries())yield[t,o,n],t++}();if(r instanceof Object)return function*(){for(let[o,n]of Object.entries(r))yield[t,o,n],t++}();if(typeof r?.[Symbol.iterator]!="function")throw new Error(`[miu] Value of ${e} is not iterable`);return function*(){for(let o of r)yield[t,void 0,o],t++}()};function H(r,e,t){let o=r.firstElementChild;if(!(o instanceof HTMLTemplateElement))throw new Error(`[miu] ${$.FOR} requires a template element`);let n=`${e.$name}.${t}`,s=d=>{let h=C(d,n);O.set(r,{store:e,path:t,items:d});let l=0;for(let[w,i]of h){let u=r.children[w+1];if(!u){let a=document.importNode(o.content,!0);r.appendChild(a),u=r.lastElementChild}u.setAttribute($.INDEX,w),i&&u.setAttribute($.KEY,i),R(u),l++}for(;r.childElementCount-1>l;){let w=r.lastElementChild,i=b.get(w);if(i)for(let u of i.values())u();w.remove()}};e.$subscribe(t,s),s(e.$get(t))}function X(r,e){let t=typeof r=="string"?document.querySelector(r):r;if(!t)throw new Error("[miu] Element not found");for(let o of e){if(A.has(o.$name))throw new Error(`[miu] Store with name "${o.$name}" already exists`);A.set(o.$name,o)}R(t)}var Z="0.2.0-2-g675239f9cf";export{v as Store,Z as VERSION,X as bind};
